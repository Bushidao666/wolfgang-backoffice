services:
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_HOST_PORT:-6380}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30

  jaeger:
    image: jaegertracing/all-in-one:1.62.0
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "16686:16686"
      - "4317:4317"
      - "4318:4318"

  backoffice-api:
    build:
      context: .
      dockerfile: backoffice-api/Dockerfile
    ports:
      - "4000:4000"
    environment:
      PORT: "4000"
      SERVICE_NAME: backoffice-api
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      SUPABASE_URL: ${SUPABASE_URL:-http://host.docker.internal:54321}
      SUPABASE_DB_URL: ${SUPABASE_DB_URL:-postgresql://postgres:postgres@host.docker.internal:54322/postgres}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-}
      JWT_SECRET: ${JWT_SECRET:-dev-secret}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      AGENT_RUNTIME_URL: ${AGENT_RUNTIME_URL:-http://agent-runtime:5000}
      AUTENTIQUE_SERVICE_URL: ${AUTENTIQUE_SERVICE_URL:-http://autentique-service:4002}
      APP_ENCRYPTION_KEY: ${APP_ENCRYPTION_KEY:-}
      FACEBOOK_API_VERSION: ${FACEBOOK_API_VERSION:-v20.0}
      OTEL_TRACING_ENABLED: ${OTEL_TRACING_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4318/v1/traces}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:4000/health"]
      interval: 10s
      timeout: 3s
      retries: 30

  backoffice-web:
    build:
      context: .
      dockerfile: backoffice-web/Dockerfile
    ports:
      - "3000:3000"
    environment:
      PORT: "3000"
      SERVICE_NAME: backoffice-web
      NODE_ENV: development
      HOSTNAME: 0.0.0.0
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4000}
      NEXT_PUBLIC_EVOLUTION_MANAGER_URL: ${NEXT_PUBLIC_EVOLUTION_MANAGER_URL:-http://localhost:4001}
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-http://localhost:54321}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
    depends_on:
      backoffice-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 3s
      retries: 30

  agent-runtime:
    build:
      context: .
      dockerfile: agent-runtime/Dockerfile
    ports:
      - "5000:5000"
    environment:
      PORT: "5000"
      SERVICE_NAME: agent-runtime
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      REDIS_URL: redis://redis:6379
      SUPABASE_DB_URL: ${SUPABASE_DB_URL:-postgresql://postgres:postgres@host.docker.internal:54322/postgres}
      SUPABASE_URL: ${SUPABASE_URL:-http://host.docker.internal:54321}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OTEL_TRACING_ENABLED: ${OTEL_TRACING_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4318/v1/traces}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5000/health"]
      interval: 10s
      timeout: 3s
      retries: 30

  evolution-manager:
    build:
      context: .
      dockerfile: evolution-manager/Dockerfile
    ports:
      - "4001:4001"
    environment:
      PORT: "4001"
      SERVICE_NAME: evolution-manager
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      SUPABASE_URL: ${SUPABASE_URL:-http://host.docker.internal:54321}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-}
      EVOLUTION_API_URL: ${EVOLUTION_API_URL:-}
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY:-}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:-dev-webhook-secret}
      TELEGRAM_WEBHOOK_BASE_URL: ${TELEGRAM_WEBHOOK_BASE_URL:-}
      TELEGRAM_WEBHOOK_SECRET: ${TELEGRAM_WEBHOOK_SECRET:-}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
    depends_on:
      redis:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:4001/health"]
      interval: 10s
      timeout: 3s
      retries: 30

  autentique-service:
    build:
      context: .
      dockerfile: autentique-service/Dockerfile
    ports:
      - "4002:4002"
    environment:
      PORT: "4002"
      SERVICE_NAME: autentique-service
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      SUPABASE_URL: ${SUPABASE_URL:-http://host.docker.internal:54321}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      AUTENTIQUE_API_KEY: ${AUTENTIQUE_API_KEY:-}
      AUTENTIQUE_BASE_URL: ${AUTENTIQUE_BASE_URL:-https://api.autentique.com.br/v2}
      AUTENTIQUE_WEBHOOK_SECRET: ${AUTENTIQUE_WEBHOOK_SECRET:-}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:4002/health"]
      interval: 10s
      timeout: 3s
      retries: 30

  facebook-capi:
    build:
      context: .
      dockerfile: facebook-capi/Dockerfile
    ports:
      - "4003:4003"
    environment:
      PORT: "4003"
      SERVICE_NAME: facebook-capi
      NODE_ENV: development
      REDIS_URL: redis://redis:6379
      FACEBOOK_API_VERSION: ${FACEBOOK_API_VERSION:-v20.0}
      SUPABASE_URL: ${SUPABASE_URL:-http://host.docker.internal:54321}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      APP_ENCRYPTION_KEY: ${APP_ENCRYPTION_KEY:-}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:4003/health"]
      interval: 10s
      timeout: 3s
      retries: 30

  prometheus:
    image: prom/prometheus:v2.55.1
    volumes:
      - ./infra/observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    depends_on:
      - backoffice-api
      - agent-runtime
      - evolution-manager
      - autentique-service
      - facebook-capi

volumes:
  redis_data:
